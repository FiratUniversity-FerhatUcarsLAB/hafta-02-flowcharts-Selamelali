digraph ATM_ParaCekme {
  rankdir=LR;
  graph [fontsize=12 labelloc="t" label="ATM - Para Çekme Sistemi (Akış Diyagramı)"];
  node [shape=box style="rounded,filled" fillcolor="#FFFFFF" fontname="Helvetica"];

  /* Kümeler (clusters) */
  subgraph cluster_atm {
    label="ATM Cihazı";
    style=rounded;
    color="#cfe2f3";
    card_insertion [label="Kart Tak / Temassız OKUT"];
    read_card [label="Kart Bilgilerini Oku\n(Çip/Bant)"];
    pin_entry [label="PIN Girişi\n(PIN şifrelenir)"];
    request_build [label="İstek Hazırla\n(İşlem türü,tutar)"];
    dispense [label="Nakit Hazırla ve Ver"];
    receipt [label="Makbuz Bas / Bildirim"];
    sensors [label="Sensör Kontrolleri\n(sıkışma,adet)"];
    eject_card [label="Kartı Ver / İşlemi Bitir"];
    atm_error [label="Hata / İptal", shape=ellipse, fillcolor="#fde9e9"];
  }

  subgraph cluster_network {
    label="Ağ / Ödeme Ağı";
    style=rounded;
    color="#d9ead3";
    gateway [label="Ödeme Ağı / Ağ Geçidi\n(Visa/Mastercard vb.)"];
  }

  subgraph cluster_bank {
    label="Banka / Arka Uç";
    style=rounded;
    color="#fce5cd";
    auth_server [label="Yetkilendirme Sunucusu\n(Banka)"];
    fraud_check [label="Dolandırıcılık Kontrolleri\n(limitler, siyah liste)"];
    account_db [label="Hesap ve Bakiye Veritabanı"];
    txn_log [label="İşlem Kayıtları (Log)"];
  }

  /* Akış */
  card_insertion -> read_card -> pin_entry -> request_build -> gateway;
  gateway -> auth_server;
  auth_server -> fraud_check;
  fraud_check -> account_db;
  account_db -> auth_server [label="Bakiye & Durum"];
  auth_server -> gateway [label="Yetki: ONAY / RED"];

  /* Onay akışı */
  gateway -> dispense [label="ONAY", color="#2e7d32"];
  dispense -> sensors -> receipt -> eject_card -> txn_log;
  txn_log -> auth_server [style=dashed];

  /* Red / Hata akışı */
  gateway -> atm_error [label="RED / HATA", color="#c62828"];
  atm_error -> eject_card;

  /* Zaman aşımı / mekanik hata */
  sensors -> atm_error [label="Sıkışma / Sayma Hatası", color="#c62828"];

  /* Geri bildirim / kullanıcıya gösterim */
  receipt -> txn_log [style=dotted];
  auth_server -> txn_log [style=dotted];

  /* Görsel düzenlemeler */
  { rank=same; gateway; request_build; }
  { rank=same; dispense; auth_server; }

  /* Ek açıklama düğümü (opsiyonel) */
  notes [shape=note label="Güvenlik: PIN gizlenmeli, Skimmer kontrolleri,\nTLS/şifreleme, EMV çip koruması" fillcolor="#fff2cc"];
  notes -> card_insertion [style=dashed];
}

